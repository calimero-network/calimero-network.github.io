---
id: building-with-icp
title: Building with Internet Computer (ICP)
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Building with Internet Computer (ICP)

Step-by-Step Guide to Building an Application for Calimero with Internet
Computer (ICP)

This tutorial will cover the following topics:

1. **Starting a Local Devnet** - Setting and configuring a local devnet using
   dfx through a script.

2. **Configuring Nodes** - Setting up nodes with ICP-specific configurations.

3. **Installing a Blockchain Demo Application** - Setup demo application that
   contains all functionalities for interaction with smart contracts.

4. **Creating context** - Create context for a blockchain demo application and
   inviting nodes into the context.

5. **Creating a Proposal** - Creating a proposal to execute cross-contract call
   to "Greet" smart contract deployed in step 3.

## Requirements

To follow this tutorial, you'll need the following:

- Calimero ICP Devnet - [Repository](https://github.com/calimero-network/icp-devnet)
- Calimero Core - Installation instructions - [Instructions](/getting-started/setup#installation)
- Demo Blockchain Integrations -
  [Repository](https://github.com/calimero-network/demo-blockchain-integrations)

You also need following tools:

- **Cargo**: Version `1.86.0-nightly` used for tutorial -
  [url](https://www.rust-lang.org/tools/install)
- **DFX** (Dfinity SDK): Version `0.24.3` used for tutorial -
  [url](https://internetcomputer.org/docs/current/developer-docs/getting-started/install)
- **Candid Extractor**: Version `0.1.5` used for tutorial -
  [url](https://crates.io/crates/candid-extractor)
- **Pnpm**: Version `9.6.0` used for tutorial -
  [url](https://pnpm.io/installation)

## Configuring a Local Devnet

We have prepared a script that will deploy the contracts and create needed accounts on local environment.
The script does the following:

- Creates accounts needed for ledger deployment.
- Deploys the context, ledger and example external contract.
- Funds the deployed context contract for initial usage.
- Calls required initial methods on deployed contracts.

The repository contains two scripts:

<Tabs
    defaultValue="fresh"
    groupId="deployment_script"
    values={[
        {label: 'Create new dfx environment', value: 'fresh'},
        {label: 'Install on existing dfx environment', value: 'addon'},
    ]}>

<TabItem value="fresh">
  Deletes the current dfx environment, creates a new one and deploys the contracts and needed accounts.
  `deploy_devnet_fresh.sh`
</TabItem>
<TabItem value="addon">
  deploy_devnet_addon.sh - Deploys the contracts and creates needed account on current dfx environment.
</TabItem>
</Tabs>

Scripts are located in Calimero ICP Devnet repository. First clone the
[repository](https://github.com/calimero-network/icp-devnet), navigate into it, give permissions to scripts for execution and run the deploy devnet script:

```bash title="Terminal"
git clone https://github.com/calimero-network/icp-devnet

cd icp-devnet

chmod +x ./deploy_devnet_addon.sh && ./deploy_devnet_addon.sh

./deploy_devnet_addon.sh
```
:::note
If you are missing any of the required tools the script will exit and tell you
which tool is missing.
:::

When the script finished you should get the following output.

```bash title="Terminal"
=== Deployment Summary ===
Context Contract ID: bkyz2-fmaaa-aaaaa-qaaaq-cai
Ledger Contract ID: bd3sg-teaaa-aaaaa-qaaba-cai

Account Information:
Minting Account: 8b768d662eeebfcbe55b180a7ac0ccb46e2ccd59cacd0b4ec3404f0c8d8b8086
Initial Account: 670183527b941adeae9e1552525853af7812d9441758c668b2e3b8553dead7a0
Archive Principal: kbwrg-ggsyr-4zl47-3z7by-owf4g-draak-xj2ni-mcvwv-6wqxc-nkjam-gae
Recipient Principal: mfefj-dsyoh-rb3b2-3yagk-rvb2p-wcb2v-fhu2n-fel2f-wqzjn-yhtxx-hqe

Deployment completed successfully!
```

:::note
Leave this terminal open as you will need values in later steps as well we will use it to fund proxy contract.
:::

## Context and Proxy Contract

### Context contract

Calimero context contract is used to create and manage contexts and their members.
More information about context contract can be found [here](/core-concepts/blockchain-integrations).

### Proxy contract

Proxy contract is used to handle blockchain operations such as cross-contract calls and trasnfers as well as storing variables.
More information about proxy contract can be found [here](/core-concepts/blockchain-integrations).

## Setting up and configuring nodes

- initialize and start 3 nodes
- install
  [blockchain demo application](https://github.com/calimero-network/demo-blockchain-integrations/tree/master/logic)
- create context for blockchain demo application
- invite all nodes in the same context

#### Initialize and Start Nodes

Open 3 terminals side by side.

```bash title="Terminal 1"
merod --node-name node1 init --server-port 2427 --swarm-port 2527
```

```bash title="Terminal 2"
merod --node-name node2 init --server-port 2428 --swarm-port 2528
```

```bash title="Terminal 3"
merod --node-name node3 init --server-port 2429 --swarm-port 2529
```

The output should look like this:
<img src="/icp-tutorial/12_init_cali_nodes.png" alt="init-nodes" />
  
You can verify nodes initialization files by looking into `~/.calimero` folder.

More on node initialization can be found [here](/getting-started/setup/).

Now we are going to start the nodes with the commands:

```bash title="Terminal 1"
cargo run -p merod -- --node-name node1 run
```

```bash title="Terminal 2"
cargo run -p merod -- --node-name node2 run
```

```bash title="Terminal 3"
cargo run -p merod -- --node-name node3 run
```

After running the nodes you should see the similar to this one:

<img src="/icp-tutorial/14_start_cali_nodes.png" alt="running-nodes" />

#### Install application

Inside the node1 terminal we are going to install blockchain demo application.

1. Clone the [Demo Blockchain Integrations](https://github.com/calimero-network/demo-blockchain-integrations) repository.
2. Navigate to the `logic` directory.
3. Build the application using the `build.sh` script, script will compile wasm file in /res directory.
4. Copy the `blockchain.wasm` file path

Applications are installed with the following command:

```bash title="Node1 Terminal"
application install file <PATH_TO_blockchain.wasm_FILE>
>Application installed <APPLICATION_ID>
```

After installing the application we can create context:

```bash title="Node1 Terminal"
context create <APPLICATION_ID> --protocol icp
>Created context <CONTEXT_ID> with identity <CONTEXT_IDENTITY>
```

After creating context we need to add node2 and node3 to it.
<br/> To be able to do that we need to create identities for node2 and node3 with whom they will join to the created context.

```bash title="Node2 Terminal"
identity new
>> Private key: <PRIVATE_KEY>
>> Public key: <PUBLIC_KEY>
```

```bash title="Node3 Terminal"
identity new
>> Private key: <PRIVATE_KEY>
>> Public key: <PUBLIC_KEY>
```

The output should look like this:

<img src="/icp-tutorial/16_create_new_identity.png" alt="create-identity" />

After creating identities we can invite node2 and node3 to join the created context.

```bash title="Node1 Terminal"
context invite <CONTEXT_ID> <CONTEXT_IDENTITY> <PUBLIC_KEY_OF_NODE2>
>> Invitation payload: <INVITATION_PAYLOAD>
```

This will generate a invitation payload which can node2 use to join the context.
Copy the invitation payload and do the following command in node2 terminal:

```bash title="Node2 Terminal"
context join <PRIVATE_KEY_OF_NODE2> <INVITATION_PAYLOAD>
>> Joined context <CONTEXT_ID>
```

Repeat the same steps for Node3.

```bash title="Node1 Terminal"
context invite <CONTEXT_ID> <PUBLIC_KEY_OF_NODE3>
```

```bash title="Node3 Terminal"
context join <PRIVATE_KEY_OF_NODE3> <INVITATION_PAYLOAD>
>> Joined context <CONTEXT_ID>
```

The output in terminal after inviting and joining nodes should look like this:
<img src="/icp-tutorial/16_invite_nodes.png" alt="join-context" />

<br/>

More on invitations and joining the context can be found
[here](https://calimero-network.github.io/tutorials/invitations-and-joinings)

Lastly we can check if all nodes are connected in context with:

```bash title="Node1 Terminal"
context ls
> <CONTEXT_ID>
```

```bash title="Node1 Terminal"
identity ls <CONTEXT_ID>
```

<img src="/icp-tutorial/18_verify_context.png" alt="context-members" />

We can see there are 3 nodes connected in context.

#### Fund Proxy Contract

We have now installed the application and created context. To be able to fully use proxy contract we need to fund it.
To get proxy contract address we need to use API GET call to retrieve it from the node.

The 3 running nodes are located on:

- https://localhost:2427
- https://localhost:2428
- https://localhost:2429.

Any of them can be queried to get the value of proxy contract id.

API endpoint to fetch proxy contract id is:
`http://localhost:2428/admin-api/contexts/CONTEXT_ID/proxy-contract`

> CONTEXT_ID can be copied from previous steps

And for our case it is:
`http://localhost:2428/admin-api/contexts/7krojDziAKRWP8KrUD8aYGL3z5peScNxPXaBWTKCFr2h/proxy-contract`

Example of request in postman:
<img src="/icp-tutorial/19_get_proxy_contract.png" alt="context-members" />

With proxy contract id we can now fund it using dfx native commands.
Reopen the terminal you used to execute devnet deployment script and do the following commands:

Switch to initial identity.

```bash title="Calimero Core Repository Terminal"
dfx identity use initial
>Using identity: "initial".
```

To fund the contract we are going to use command:

```bash
dfx canister call <LEDGER_CONTRACT_ID> icrc1_transfer "(record { to = record { owner = principal \"<PROXY_CONTRACT_ID> \"; subaccount = null}; amount = 1_000_000_000; fee = null; memo = null; from_subaccount = null; created_at_time = null})"
```

> LEDGER_CONTRACT_ID - this value can be viewed when ./deploy_devnet.sh script
> finishes. 
> <br/> In our case value its: `bd3sg-teaaa-aaaaa-qaaba-cai`
>
> PROXY_CONTRACT_ID - value we got in previous step. 
> <br/> In our case value its: `b77ix-eeaaa-aaaaa-qaada-cai`

```bash title="Calimero Core Repository Terminal"
dfx canister call bd3sg-teaaa-aaaaa-qaaba-cai icrc1_transfer "(record { to = record { owner = principal \"b77ix-eeaaa-aaaaa-qaada-cai"\"; subaccount = null}; amount = 1_000_000_000; fee = null; memo = null; from_subaccount = null; created_at_time = null})"
> (variant { Ok = 1 : nat })
```

And verify the contract balance:

```bash title="Calimero Core Repository Terminal"
dfx canister call bd3sg-teaaa-aaaaa-qaaba-cai icrc1_balance_of "(record { owner = principal \"b77ix-eeaaa-aaaaa-qaada-cai\"; subaccount = null })"
> (1_000_000_000 : nat)
```

## Blockchain Demo Application

This application is used to demonstrate how to interact with Calimero Proxy contract through creating, approving and executing proposals.

The proxy contract supports the following types of proposals:

- **External function call** - Enables cross-contract call execution.
- **Transfer** - Allows transferring funds.
- **Set approval threshold** - Specifies the number of approvals required for
  proposal execution.
- **Set active proposal limit** - Defines the maximum number of active
  proposals.
- **Set context variables** - Allows setting key-value pairs for context
  variables.

:::info

By deafult each proposal needs 3 approvals before it is executed.

:::

In this tutorial we are going to use 3 nodes to be able to execute proposals and
we will perform a `set_greet` cross-contract call directly from the node.

You should already have repository cloned from previous steps.

> While the demo focuses on specific functionality, you can customize the
> application to suit your needs. Instead of building a complete frontend, this
> demo serves as a foundation that you can extend to create a fully-featured
> frontend application tailored to your requirements.

Navigate to frontend directory and install dependencies.
```bash title="Terminal"
cd demo-blockchain-integrations/app && pnpm install && pnpm run dev
```

<details>
  <summary>Terminal output for started application image</summary>
  <p>
    <img
      src="/icp-tutorial/23_start_blockchain_demo_app.png"
      alt="running-demo-app"
    />
  </p>
</details>

For this application we will also need application ID which can be copied from
any of previous steps or use following command from any of node terminals.

```bash title="Node1 Terminal"
application ls
> <APPLICATION_ID>
```

<details>
  <summary>Get application id terminal output image</summary>
  <p>
    <img src="/icp-tutorial/22_get_app_id.png" alt="get-app-id" />
  </p>
</details>

Open web application on given URL and go through the setup, copy application ID
and enter the node URL. We will do this process for all 3 nodes.

<details>
  <summary>Blockchain demo application setup for node1 image</summary>
  <p>
    <img src="/icp-tutorial/23_login_node1.png" alt="setup-app" />
  </p>
</details>

After you login you should see the Blockchain Demo Application

<details>
  <summary>Blockchain demo application image</summary>
  <p>
    <img src="/icp-tutorial/24_create_threshold_proposal.png" alt="demo-app" />
  </p>
</details>

### Change Approval Threshold Proposal

First we are going to create an approval threshold change proposal so future
proposals can be executed by only 1 node. As mentioned earlier each proposal by
default needs 3 approvals to be executed.

<details>
  <summary>Create proposal image</summary>
  <p>
    <img src="/icp-tutorial/25_proposal_creation.png" alt="create-proposal" />
  </p>
</details>

After proposal is created you will get the alert that proposal is created and it will be shown in other frontend applications by selecting it in select field.

### Cross-Contract Call Proposal

At this point proposal approval threshold is 1, meaning proposal will be
executed on creation. This means when we create cross-contract call proposal it
will insantly be executed.

So lets create a cross-contract call proposal.

<details>
  <summary>Create cross-contract call proposal image</summary>
  <p>
    <img
      src="/icp-tutorial/33_create_cross_call_proposal.png"
      alt="create-ccc"
    />
  </p>
</details>

Values for this form can be found in previous steps and for our case they are:

- **Contract ID**: br5f7-7uaaa-aaaaa-qaaca-cai
- **Method Name**: set_greet (defined in .did file form previous steps)
- **Deposit**: 0
- **Arguments**: for this smart contract we will be using "name" as key and
  "calimero" as value.

After we create proposal it will be executed.

:::note

It's important to note that in this tutorial, we use a function call that does
not require a deposit for execution.

On the other hand, there are examples where cross-contract calls require a
deposit. For instance, in the case of an ERC20 token implementation, the
following steps typically occur:

1. The contract detects that an attached deposit is present.
2. It calls the deployed ledger contract to enable the external contract (the
   contract being called) to withdraw funds. Before doing so, it sets the
   allowance to 0 to prevent vulnerabilities related to the Attack Vector.
3. It then calls the ledger contract again to set the allowance equal to the
   deposit attached to the call.
4. The external contract is called, and it must contain logic to withdraw the
   funds that have been allocated for it in the ledger contract.
5. After the cross-contract call is completed, the proxy contract sets the
   allowance back to 0 to ensure security.

:::

And now for the last step we can run get_greet method from beggining to see if
greet changed.

<details>
  <summary>Terminal ouput for get_greet method image</summary>
  <p>
    <img
      src="/icp-tutorial/35_verify_change_method.png"
      alt="get-greet-image"
    />
  </p>
</details>

> We can see in terminal the first time we used command output was: Hello,
> world! And after proposal was executed greet was changed to: Hello, calimero!

## Conclusion

This tutorial has covered all the essential steps developers need to build an
application for Calimero and ICP, from setting up the environment to deploying a
fully functional smart contract. By following this guide, you should now have a
solid understanding of the development workflow and how to build your own ICP
application for Calimero.

Feel free to use our demo applications as a starting point to build and
customize your own application. If you have any questions or need assistance,
don't hesitate to reach out to us on Socials. We're here to help!
